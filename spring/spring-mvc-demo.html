<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta name="google-site-verification" content="DwDg4EuywHWNZUkTC7sG0WGv_UQekM4uRtOoaGuDJHc">
<meta name="baidu-site-verification" content="hkLiBHH93D">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="手写Spring(一) 实现简易版Spring MVC">




  <meta name="keywords" content="Spring,">




  <link rel="alternate" href="/default" title="JinJin's Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1">



<link rel="canonical" href="https://jinzzzzz.github.io/spring/spring-mvc-demo.html">


<meta name="description" content="目录：   实现思路 配置阶段 初始化阶段 调用阶段   开始实现 配置 创建Servlet Servlet初始化 加载配置文件 扫描相关类 将实例保存到IOC容器中 依赖注入 初始化URL映射关系 映射内部类Handler   Servlet方法调用 获取匹配的Handler 类型转换     运行效果   实现思路 依赖Servlet api实现 本篇博客代码地址:https://github">
<meta name="keywords" content="Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="手写Spring(一) 实现简易版Spring MVC">
<meta property="og:url" content="https://jinzzzzz.github.io/spring/spring-mvc-demo.html">
<meta property="og:site_name" content="JinJin&#39;s Blog">
<meta property="og:description" content="目录：   实现思路 配置阶段 初始化阶段 调用阶段   开始实现 配置 创建Servlet Servlet初始化 加载配置文件 扫描相关类 将实例保存到IOC容器中 依赖注入 初始化URL映射关系 映射内部类Handler   Servlet方法调用 获取匹配的Handler 类型转换     运行效果   实现思路 依赖Servlet api实现 本篇博客代码地址:https://github">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/jinzzzzz/image/master/blog/spring/springmvc-demo.png">
<meta property="og:updated_time" content="2019-04-01T03:02:08.375Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="手写Spring(一) 实现简易版Spring MVC">
<meta name="twitter:description" content="目录：   实现思路 配置阶段 初始化阶段 调用阶段   开始实现 配置 创建Servlet Servlet初始化 加载配置文件 扫描相关类 将实例保存到IOC容器中 依赖注入 初始化URL映射关系 映射内部类Handler   Servlet方法调用 获取匹配的Handler 类型转换     运行效果   实现思路 依赖Servlet api实现 本篇博客代码地址:https://github">
<meta name="twitter:image" content="https://raw.githubusercontent.com/jinzzzzz/image/master/blog/spring/springmvc-demo.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">






<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  





<!--百度统计-->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b733e1eaeacbf8f87d3be047f28c3973";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    <title> 手写Spring(一) 实现简易版Spring MVC - JinJin's Blog </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">JinJin's Blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          手写Spring(一) 实现简易版Spring MVC
        
      </h1>

      <time class="post-time">
          2019-03-30
      </time>
    </header>



    
            <div class="post-content">
            <p>目录：</p>
<!-- toc -->
<ul>
<li><a href="#实现思路">实现思路</a><ul>
<li><a href="#配置阶段">配置阶段</a></li>
<li><a href="#初始化阶段">初始化阶段</a></li>
<li><a href="#调用阶段">调用阶段</a></li>
</ul>
</li>
<li><a href="#开始实现">开始实现</a><ul>
<li><a href="#配置">配置</a></li>
<li><a href="#创建servlet">创建Servlet</a></li>
<li><a href="#servlet初始化">Servlet初始化</a><ul>
<li><a href="#加载配置文件">加载配置文件</a></li>
<li><a href="#扫描相关类">扫描相关类</a></li>
<li><a href="#将实例保存到ioc容器中">将实例保存到IOC容器中</a></li>
<li><a href="#依赖注入">依赖注入</a></li>
<li><a href="#初始化url映射关系">初始化URL映射关系</a></li>
<li><a href="#映射内部类handler">映射内部类Handler</a></li>
</ul>
</li>
<li><a href="#servlet方法调用">Servlet方法调用</a><ul>
<li><a href="#获取匹配的handler">获取匹配的Handler</a></li>
<li><a href="#类型转换">类型转换</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#运行效果">运行效果</a></li>
</ul>
<!-- tocstop -->
<h1><span id="实现思路">实现思路</span></h1><blockquote>
<p><strong>依赖Servlet api实现</strong></p>
<p>本篇博客代码地址:<a href="https://github.com/jinzzzzz/spring-demo" target="_blank" rel="noopener">https://github.com/jinzzzzz/spring-demo</a></p>
</blockquote>
<h2><span id="配置阶段">配置阶段</span></h2><ul>
<li>在<code>web.xml</code>中配置自定义Servlet <code>DispatcherServlet</code></li>
<li>设置<code>url-pattern</code>匹配请求</li>
<li>配置自定义注解,如<code>@Autowrited</code></li>
</ul>
<h2><span id="初始化阶段">初始化阶段</span></h2><ul>
<li>调用Servlet 的<code>init</code>初始化方法 加载配置文件</li>
<li>创建一个Map作为简易版的IOC容器存储</li>
<li>扫描配置文件路径中的类并创建实例化至IOC容器中</li>
<li>扫描IOC容器中的实例，为实例中需要赋值的属性进行依赖注入</li>
<li>将url和方法的映射保存到<code>HandlerMapping</code></li>
</ul>
<h2><span id="调用阶段">调用阶段</span></h2><ul>
<li>调用Servlet 的<code>doGet</code>或<code>doPost</code>方法</li>
<li>根据用户输入的url进行匹配<code>HandlerMapping</code>，找到对应的方法。</li>
<li>动态匹配方法的参数并进行反射调用方法返回结果。</li>
<li>将返回结果输出至浏览器</li>
</ul>
<h1><span id="开始实现">开始实现</span></h1><h2><span id="配置">配置</span></h2><p>创建<code>application.properties</code>配置文件，配置需要扫描的包路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scanPackage=com.jin.spring.demo</span><br></pre></td></tr></table></figure>
<p>配置<code>web.xml</code>文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/j2ee"</span> <span class="attr">xmlns:javaee</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:web</span>=<span class="string">"http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">version</span>=<span class="string">"2.4"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>mvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.jin.spring.demo.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>application.properties<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>mvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中<code>DispatcherServlet</code>就是用来模拟Spring功能的Servlet类。</p>
<p>创建自定义注解<code>@Autowired</code>、<code>@Controller</code>、<code>@RequestMapping</code>、<code>RequestParam</code>、<code>Service</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.FIELD&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Autowired &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建业务接口<code>DemoService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoService</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建<code>DemoService</code>实现类并配置注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServiceImpl</span> <span class="keyword">implements</span> <span class="title">DemoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello "</span>+name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置请求控制器<code>DemoController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DemoService demoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">(@RequestParam(<span class="string">"name"</span>)</span> String name, HttpServletResponse resp) <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        resp.getWriter().write(demoService.hello(name));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="创建servlet">创建Servlet</span></h2><p>核心逻辑实现在<code>DispatcherServlet</code>中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jin.spring.demo.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jin.spring.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletConfig;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOCATION = <span class="string">"contextConfigLocation"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Properties p = <span class="keyword">new</span> Properties();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; classNames = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Object&gt; ioc = <span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存Url和方法的映射关系</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Handler&gt; handlerMapping = <span class="keyword">new</span> ArrayList&lt;Handler&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DispatcherServlet</span><span class="params">()</span></span>&#123; <span class="keyword">super</span>(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化，加载配置文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、加载配置文件</span></span><br><span class="line">        doLoadConfig(config.getInitParameter(LOCATION));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、扫描所有相关的类</span></span><br><span class="line">        doScanner(p.getProperty(<span class="string">"scanPackage"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、初始化所有相关类的实例，并保存到IOC容器中</span></span><br><span class="line">        doInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、依赖注入</span></span><br><span class="line">        doAutowired();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5、构造HandlerMapping</span></span><br><span class="line">        initHandlerMapping();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//提示信息</span></span><br><span class="line">        System.out.println(<span class="string">"mvc is init"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行业务处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//匹配对应方法</span></span><br><span class="line">            doDispatch(req,resp);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            resp.getWriter().write(<span class="string">"500 Exception,Details:\r\n"</span></span><br><span class="line">                    + Arrays.toString(e.getStackTrace()).replaceAll(<span class="string">"\\[|\\]"</span>, <span class="string">""</span>)</span><br><span class="line">                    .replaceAll(<span class="string">",\\s"</span>, <span class="string">"\r\n"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="servlet初始化">Servlet初始化</span></h2><p>Servlet初始化时执行init()方法，初始化相关内容</p>
<h3><span id="加载配置文件">加载配置文件</span></h3><p>根据路径加载配置文件，取出需要的信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doLoadConfig</span><span class="params">(String location)</span></span>&#123;</span><br><span class="line">        InputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//加载配置文件</span></span><br><span class="line">            fis = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(location);</span><br><span class="line">            <span class="comment">//读取配置文件</span></span><br><span class="line">            p.load(fis);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">null</span> != fis)&#123;fis.close();&#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3><span id="扫描相关类">扫描相关类</span></h3><p>扫描配置文件中的路径，将所有的类名保存到集合中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doScanner</span><span class="params">(String packageName)</span></span>&#123;</span><br><span class="line">        <span class="comment">//将所有的包路径转换为文件路径</span></span><br><span class="line">        URL url = <span class="keyword">this</span>.getClass().getClassLoader().getResource(<span class="string">"/"</span> + packageName.replaceAll(<span class="string">"\\."</span>, <span class="string">"/"</span>));</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span>==url)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        File dir = <span class="keyword">new</span> File(url.getFile());</span><br><span class="line">        File[] dirs=dir.listFiles();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> == dirs)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//找出所有的文件名称,去除.class后缀</span></span><br><span class="line">        <span class="keyword">for</span> (File file :dirs) &#123;</span><br><span class="line">            <span class="comment">//如果是文件夹则递归</span></span><br><span class="line">            <span class="keyword">if</span>(file.isDirectory())&#123;</span><br><span class="line">                doScanner(packageName + <span class="string">"."</span> + file.getName());</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                classNames.add(packageName + <span class="string">"."</span> + file.getName().replace(<span class="string">".class"</span>, <span class="string">""</span>).trim());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3><span id="将实例保存到ioc容器中">将实例保存到IOC容器中</span></h3><p>根据类的注解决定是否创建实例，并且保存到IOC容器中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//扫描路径中没有找到任何类则直接返回</span></span><br><span class="line">        <span class="keyword">if</span>(classNames.size() == <span class="number">0</span>)&#123; <span class="keyword">return</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//循环查找到的所有类,对加了注解的类进行处理</span></span><br><span class="line">            <span class="keyword">for</span> (String className : classNames) &#123;</span><br><span class="line">                <span class="comment">//根据类名查找</span></span><br><span class="line">                Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">                <span class="comment">//判断是否加了Controller注解</span></span><br><span class="line">                <span class="keyword">if</span>(clazz.isAnnotationPresent(Controller.class))&#123;</span><br><span class="line">                    <span class="comment">//默认将首字母小写作为beanName</span></span><br><span class="line">                    String beanName = lowerFirst(clazz.getSimpleName());</span><br><span class="line">                    <span class="comment">//将beanName作为key放入到ioc容器中</span></span><br><span class="line">                    ioc.put(beanName, clazz.newInstance());</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(clazz.isAnnotationPresent(Service.class))&#123;</span><br><span class="line">                    <span class="comment">//判断是否加了Service注解</span></span><br><span class="line">                    Service service = clazz.getAnnotation(Service.class);</span><br><span class="line">                    String beanName = service.value();</span><br><span class="line">                    <span class="comment">//如果注解中value不为空，则用此value</span></span><br><span class="line">                    <span class="keyword">if</span>(!<span class="string">""</span>.equals(beanName.trim()))&#123;</span><br><span class="line">                        ioc.put(beanName, clazz.newInstance());</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//注解没有设置value，则使用接口的类型作为key</span></span><br><span class="line">                    Class&lt;?&gt;[] interfaces = clazz.getInterfaces();</span><br><span class="line">                    <span class="keyword">for</span> (Class&lt;?&gt; i : interfaces) &#123;</span><br><span class="line">                        <span class="comment">//将接口的类型作为key放入到ioc容器中</span></span><br><span class="line">                        ioc.put(i.getName(), clazz.newInstance());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 首字母小母</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str 字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 小写</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">lowerFirst</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> [] chars = str.toCharArray();</span><br><span class="line">        chars[<span class="number">0</span>] += <span class="number">32</span>;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(chars);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3><span id="依赖注入">依赖注入</span></h3><p>根据IOC容器中实例的属性上的注解决定为字段赋值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAutowired</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//ioc容器为空则直接返回</span></span><br><span class="line">    <span class="keyword">if</span>(ioc.isEmpty())&#123; <span class="keyword">return</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为ioc中所有的实例进行依赖注入</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : ioc.entrySet()) &#123;</span><br><span class="line">        <span class="comment">//拿到实例对象中的所有属性</span></span><br><span class="line">        Field[] fields = entry.getValue().getClass().getDeclaredFields();</span><br><span class="line">        <span class="comment">//拿到实例的所有属性判断是否需要依赖注入</span></span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            <span class="comment">//如果不需要依赖注入则直接返回</span></span><br><span class="line">            <span class="keyword">if</span>(!field.isAnnotationPresent(Autowired.class))&#123; <span class="keyword">continue</span>; &#125;</span><br><span class="line"></span><br><span class="line">            Autowired autowired = field.getAnnotation(Autowired.class);</span><br><span class="line">            <span class="comment">//如果设置了value,则根据value进行装配</span></span><br><span class="line">            String beanName = autowired.value().trim();</span><br><span class="line">            <span class="comment">//若没有设置value则根据类型进行装配</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="string">""</span>.equals(beanName))&#123;</span><br><span class="line">                beanName = field.getType().getName();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//设置私有属性的访问权限</span></span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//注入属性值</span></span><br><span class="line">                field.set(entry.getValue(), ioc.get(beanName));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="初始化url映射关系">初始化URL映射关系</span></h3><p>根据方法及类的注解初始化url和方法的映射关系，并保存到HandlerMapping中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initHandlerMapping</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ioc.isEmpty())&#123; <span class="keyword">return</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从ioc的实例中取出需要做url映射的类</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : ioc.entrySet()) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = entry.getValue().getClass();</span><br><span class="line">            <span class="comment">//如果此类不需要映射则直接返回</span></span><br><span class="line">            <span class="keyword">if</span>(!clazz.isAnnotationPresent(Controller.class))&#123; <span class="keyword">continue</span>; &#125;</span><br><span class="line"></span><br><span class="line">            String url = <span class="string">""</span>;</span><br><span class="line">            <span class="comment">//获取Controller的url配置</span></span><br><span class="line">            <span class="keyword">if</span>(clazz.isAnnotationPresent(RequestMapping.class))&#123;</span><br><span class="line">                RequestMapping requestMapping = clazz.getAnnotation(RequestMapping.class);</span><br><span class="line">                url = requestMapping.value();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取Method的url配置</span></span><br><span class="line">            Method[] methods = clazz.getMethods();</span><br><span class="line">            <span class="comment">//获取类中的所有方法,将需要映射的方法加入handlerMapping中</span></span><br><span class="line">            <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//没有加RequestMapping注解的直接忽略</span></span><br><span class="line">                <span class="keyword">if</span>(!method.isAnnotationPresent(RequestMapping.class))&#123; <span class="keyword">continue</span>; &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//映射URL</span></span><br><span class="line">                RequestMapping requestMapping = method.getAnnotation(RequestMapping.class);</span><br><span class="line">                String regex = (<span class="string">"/"</span> + url + requestMapping.value()).replaceAll(<span class="string">"/+"</span>, <span class="string">"/"</span>);</span><br><span class="line">                <span class="comment">//正则匹配</span></span><br><span class="line">                Pattern pattern = Pattern.compile(regex);</span><br><span class="line">                <span class="comment">//加入到handlerMapping中</span></span><br><span class="line">                handlerMapping.add(<span class="keyword">new</span> Handler(pattern,entry.getValue(),method));</span><br><span class="line">                System.out.println(<span class="string">"mapping "</span> + regex + <span class="string">","</span> + method);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3><span id="映射内部类handler">映射内部类Handler</span></h3><p>保存url和方法以及类的实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Object controller;	<span class="comment">//保存方法对应的实例</span></span><br><span class="line">        Method method;		<span class="comment">//保存映射的方法</span></span><br><span class="line">        Pattern pattern;   <span class="comment">//正则</span></span><br><span class="line">        Map&lt;String,Integer&gt; paramIndexMapping;	<span class="comment">//参数顺序</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 构造一个Handler基本的参数</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> controller 方法对应的实例</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> method 映射的方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Handler(Pattern pattern,Object controller,Method method)&#123;</span><br><span class="line">            <span class="keyword">this</span>.controller = controller;</span><br><span class="line">            <span class="keyword">this</span>.method = method;</span><br><span class="line">            <span class="keyword">this</span>.pattern = pattern;</span><br><span class="line"></span><br><span class="line">            paramIndexMapping = <span class="keyword">new</span> HashMap&lt;String,Integer&gt;();</span><br><span class="line">            putParamIndexMapping(method);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putParamIndexMapping</span><span class="params">(Method method)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//提取方法中加了注解的参数</span></span><br><span class="line">            Annotation[] [] pa = method.getParameterAnnotations();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pa.length ; i ++) &#123;</span><br><span class="line">                <span class="comment">//获取注解</span></span><br><span class="line">                <span class="keyword">for</span>(Annotation a : pa[i])&#123;</span><br><span class="line">                    <span class="comment">//如果是需要赋值的属性则将属性名称和位置加入到paramIndexMapping中</span></span><br><span class="line">                    <span class="keyword">if</span>(a <span class="keyword">instanceof</span> RequestParam)&#123;</span><br><span class="line">                        String paramName = ((RequestParam) a).value();</span><br><span class="line">                        <span class="keyword">if</span>(!<span class="string">""</span>.equals(paramName.trim()))&#123;</span><br><span class="line">                            paramIndexMapping.put(paramName, i);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//提取方法中的request和response参数</span></span><br><span class="line">            Class&lt;?&gt; [] paramsTypes = method.getParameterTypes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paramsTypes.length ; i ++) &#123;</span><br><span class="line">                Class&lt;?&gt; type = paramsTypes[i];</span><br><span class="line">                <span class="keyword">if</span>(type == HttpServletRequest.class ||</span><br><span class="line">                        type == HttpServletResponse.class)&#123;</span><br><span class="line">                    paramIndexMapping.put(type.getName(),i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2><span id="servlet方法调用">Servlet方法调用</span></h2><p>调用doGet()或doPost()方法时，调用doDispatch(req,resp)方法匹配url</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest req,HttpServletResponse resp)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//获取匹配的Handler</span></span><br><span class="line">            Handler handler = getHandler(req);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(handler == <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="comment">//如果没有匹配上，返回404错误</span></span><br><span class="line">                resp.getWriter().write(<span class="string">"404 Not Found"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取方法的参数列表</span></span><br><span class="line">            Class&lt;?&gt; [] paramTypes = handler.method.getParameterTypes();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//保存所有需要自动赋值的参数值</span></span><br><span class="line">            Object [] paramValues = <span class="keyword">new</span> Object[paramTypes.length];</span><br><span class="line"></span><br><span class="line">            Map&lt;String,String[]&gt; params = req.getParameterMap();</span><br><span class="line">            <span class="comment">//获取请求参数列表,将方法对应的参数进行赋值</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String[]&gt; param : params.entrySet()) &#123;</span><br><span class="line">                String value = Arrays.toString(param.getValue())</span><br><span class="line">                        .replaceAll(<span class="string">"\\[|\\]"</span>, <span class="string">""</span>).replaceAll(<span class="string">",\\s"</span>, <span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//如果找到匹配的对象，则开始填充参数值</span></span><br><span class="line">                <span class="keyword">if</span>(!handler.paramIndexMapping.containsKey(param.getKey()))&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                <span class="keyword">int</span> index = handler.paramIndexMapping.get(param.getKey());</span><br><span class="line">                paramValues[index] = convert(paramTypes[index],value);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置方法中的request和response对象</span></span><br><span class="line">            Integer reqIndex = handler.paramIndexMapping.get(HttpServletRequest.class.getName());</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span>!=reqIndex) &#123;</span><br><span class="line">                paramValues[reqIndex] = req;</span><br><span class="line">            &#125;</span><br><span class="line">            Integer respIndex = handler.paramIndexMapping.get(HttpServletResponse.class.getName());</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span>!=respIndex) &#123;</span><br><span class="line">                paramValues[respIndex] = resp;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//反射调用方法</span></span><br><span class="line">            handler.method.invoke(handler.controller, paramValues);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3><span id="获取匹配的handler">获取匹配的Handler</span></h3><p>从初始化阶段保存的url和方法的映射关系，取出匹配的Handler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Handler <span class="title">getHandler</span><span class="params">(HttpServletRequest req)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(handlerMapping.isEmpty())&#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line"></span><br><span class="line">        String url = req.getRequestURI();</span><br><span class="line">        String contextPath = req.getContextPath();</span><br><span class="line">        url = url.replace(contextPath, <span class="string">""</span>).replaceAll(<span class="string">"/+"</span>, <span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//循环handlerMapping匹配Handler</span></span><br><span class="line">        <span class="keyword">for</span> (Handler handler : handlerMapping) &#123;</span><br><span class="line">            Matcher matcher = handler.pattern.matcher(url);</span><br><span class="line">            <span class="comment">//如果没有匹配上继续下一个匹配</span></span><br><span class="line">            <span class="keyword">if</span>(!matcher.matches())&#123; <span class="keyword">continue</span>; &#125;</span><br><span class="line">            <span class="keyword">return</span> handler;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3><span id="类型转换">类型转换</span></h3><p>转换方法的参数类型，目前只增加了Integer类型的匹配，默认String</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">convert</span><span class="params">(Class&lt;?&gt; type,String value)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(Integer.class == type)&#123;</span><br><span class="line">           <span class="keyword">return</span> Integer.valueOf(value);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> value;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>至此,手写简易版的Spring MVC已经完成，并且可以使用了。</p>
<h1><span id="运行效果">运行效果</span></h1><p><img src="https://raw.githubusercontent.com/jinzzzzz/image/master/blog/spring/springmvc-demo.png" alt></p>
<p>当然，真正的 Spring 要复杂很多，主要是通过手写的形式，了解 Spring 的基本设计思路；</p>
<p>本篇博客的代码只是用Servlet实现了简易版的Spring MVC，还有很多可以优化的空间；</p>
<p>在之后的博客里会继续手写Spring的基本核心功能。</p>

            </div>
          

    
      <footer class="post-footer">
      <ul class="post-copyright">
        <li class="post-copyright-author">
            <span>本文作者：</span>Jin Jin
        </li>
        <li class="post-copyright-link">
          <span>本文链接：</span>
          <a href="https://jinzzzzz.github.io//spring/spring-mvc-demo.html" title="手写Spring(一) 实现简易版Spring MVC">https://jinzzzzz.github.io/spring/spring-mvc-demo.html</a>
        </li>
        <li class="post-copyright-license">
          <span>版权： </span>
          本站文章均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议，请勿用于商业，转载注明出处！
        </li>
      </ul>
		
		<div class="post-tags">
		  
			<a href="/tags/Spring/">Spring</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/mysql/mysql-innodb.html">
        <span class="next-text nav-default">Innodb锁机制和MVCC原理</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>
      
        





    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

    
    
    
    
    
    

    <div id="gitalk-container"></div>

    <script>
        var gitalk = new Gitalk({
            clientID: '217672eb040280538293',
            clientSecret: '5a950867142dbcfd9fdc3de4491455bd3651c1a8',
            repo: 'jinzzzzz.github.io',
            owner: 'jinzzzzz',
            admin: 'jinzzzzz',
            id: location.pathname,      // Ensure uniqueness and length less than 50
            distractionFreeMode: 'false'  // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    </script>


      
      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2018 -
    
    2019
    <span class="footer-author">Jin Jin.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  



    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

<!--prettify代码高亮脚本引入-->


  </body>
</html>
